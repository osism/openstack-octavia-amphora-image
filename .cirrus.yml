---
compute_engine_instance:
  image_project: cirrus-images
  image: family/docker-kvm
  platform: linux
  cpu: 4
  memory: 16G
  disk: 100
  nested_virtualization: true

# environment variables

env:
  DEBIAN_FRONTEND: noninteractive
  HOME: "$CIRRUS_WORKING_DIR"
  MINIO_ACCESS_KEY: "ENCRYPTED[ee68006d95a0c24238642dc37fa69659f4971c42bac5a012caf3344225f8767740e9bf5d85a52b1cea30d93f260ac445]"
  MINIO_SECRET_KEY: "ENCRYPTED[b668bb22014144c7cdc5f598cbdce9ea08982a0db610a362a515cafc956aac445106e2fff06286fd2b9ab4c4bc15a52b]"

# task definitions

victoria_task:
  skip: "!changesInclude('.cirrus.yml', 'scripts/**')"

  environment:
    VERSION: victoria

  install_script:
    - apt-get update
    - apt-get install -y python3-pip kpartx qemu-utils git debootstrap
    - pip install -r requirements.txt
    - wget https://dl.min.io/client/mc/release/linux-amd64/mc
    - chmod +x mc
    - ./mc alias set minio https://minio.services.osism.tech $MINIO_ACCESS_KEY $MINIO_SECRET_KEY

  submodules_script:
    - git submodule init
    - git submodule update

  build_script:
    - bash scripts/build.sh

  push_script:
    - ./mc cp octavia/diskimage-create/octavia-amphora-haproxy-$VERSION.qcow2 minio/openstack-octavia-apmphora-image
    - ./mc policy set download minio/openstack-octavia-apmphora-image/octavia-amphora-haproxy-$VERSION.qcow2

wallaby_task:
  skip: "!changesInclude('.cirrus.yml', 'scripts/**')"

  environment:
    VERSION: wallaby

  install_script:
    - apt-get update
    - apt-get install -y python3-pip kpartx qemu-utils git debootstrap
    - pip install -r requirements.txt
    - wget https://dl.min.io/client/mc/release/linux-amd64/mc
    - chmod +x mc
    - ./mc alias set minio https://minio.services.osism.tech $MINIO_ACCESS_KEY $MINIO_SECRET_KEY

  submodules_script:
    - git submodule init
    - git submodule update

  build_script:
    - bash scripts/build.sh

  push_script:
    - ./mc cp octavia/diskimage-create/octavia-amphora-haproxy-$VERSION.qcow2 minio/openstack-octavia-apmphora-image
    - ./mc policy set download minio/openstack-octavia-apmphora-image/octavia-amphora-haproxy-$VERSION.qcow2
