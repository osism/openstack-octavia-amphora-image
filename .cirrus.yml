---
compute_engine_instance:
  image_project: cirrus-images
  image: family/docker-kvm
  platform: linux
  cpu: 4
  memory: 16G
  disk: 100
  nested_virtualization: true

# environment variables

env:
  DEBIAN_FRONTEND: noninteractive
  HOME: "$CIRRUS_WORKING_DIR"
  MINIO_ACCESS_KEY: "ENCRYPTED[11290d592bdfbf2b124a95b00bb80bc3868a7e30ea98f7dc338e9eb347bab9ac66d1fdb5e547178da43cba6d3f521d05]"
  MINIO_SECRET_KEY: "ENCRYPTED[692e1962c6415fedd4a97a4dd91529e05b1e05035eba73c9a3eadfb537c387727dd727016199ed5108a58aec538b60bf]"

# task definitions

zed_task:
  environment:
    VERSION: zed
    DISTRIBUTION_RELEASE: jammy

  install_script:
    - apt-get update
    - apt-get install -y python3-pip kpartx qemu-utils git debootstrap
    - pip install -r requirements.txt
    - wget https://dl.min.io/client/mc/release/linux-amd64/mc
    - chmod +x mc
    - ./mc alias set minio https://minio.services.osism.tech $MINIO_ACCESS_KEY $MINIO_SECRET_KEY

  submodules_script:
    - git submodule init
    - git submodule update

  build_script:
    - bash scripts/build.sh

  push_script:
    - ./mc cp octavia/diskimage-create/octavia-amphora-haproxy-$VERSION.qcow2 minio/openstack-octavia-amphora-image
    - ./mc policy set download minio/openstack-octavia-amphora-image/octavia-amphora-haproxy-$VERSION.qcow2
